<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/6.5.3/rxjs.umd.js" crossorigin="anonymous"></script>
    <script src="index.js"></script>
    <link rel="stylesheet" href="index.css">

    <title>WebSocket</title>
</head>

<body>
    <div id="container">
        <!-- rxjs event -->
    </div>
    <script>

        var loc = window.location;
        var uri = 'ws:';

        if (loc.protocol === 'https:') {
        uri = 'wss:';
        }
        uri += '//' + loc.host;
        uri += '/v1/fb/webhook/socket.io';

        // console.log(loc.pathname)

        ws = new WebSocket(uri)

        ws.onopen = function() {
            console.log('Connected')
        }

        ws.onmessage = function(evt) {

            var observable = rxjs.of(evt).pipe(rxjs.operators.delay(2000))

            observable.subscribe(
                x => { 
                    const element = document.getElementById('container');
                    let response = JSON.parse(evt.data)

                    const newElement = document.createElement('div')

                    newElement.innerText = response.keyword + response.intent + response.distance;
                    element.appendChild(newElement)
                },
                e => { console.log(e) },
                () => { console.log("send complete") }
            )
        }

        setInterval(function() {
        ws.send('สวัสดีครับ');
        }, 5000);

    </script>
</body>
</html>